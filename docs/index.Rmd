---
title: "SBCK Watershed Brigade Dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: fill
---

<style>

body {
padding-top:0px
}

.navbar{
visibility: hidden
}

</style>

```{r}
# Load necessary packages
library(tidyverse) # For data wrangling
library(leaflet) # For mapping 
library(googlesheets4) # For loading data from Google Sheets
library(flexdashboard) # Tools for making the dashboard

# Authentication guidance: https://stackoverflow.com/questions/63535190/connect-to-googlesheets-via-shiny-in-r-with-googlesheets4/70215575#70215575
# Set authentication token to be stored in a folder called `.secrets`
#options(gargle_oauth_cache = ".secrets")

# Authenticate manually
#gs4_auth()
# If successful, the previous step stores a token file.
# Check that a file has been created with:
#list.files(".secrets/")
# Check that the non-interactive authentication works by first deauthorizing: 
#gs4_deauth()

# Authenticate using token. If no browser opens, the authentication works.
# gs4_auth(cache = ".secrets", email = "gavinmcd@gmail.com", use_oob = TRUE)
#gs4_auth(token = gs4_token())

# designate project-specific cache
# options(gargle_oauth_cache = '.secrets')
# # check the value of the option, if you like
# gargle::gargle_oauth_cache()
# 
# # trigger auth on purpose to store a token in the specified cache
# # a broswer will be opened
# googlesheets4::gs4_auth()
# 
# # see your token file in the cache, if you like
# list.files('.secrets/')
# 
# # deauth
# gs4_deauth()
# #In sheets_auth() we can specify where the token is cached and which
# #email we used to authenticate.
# # sheets reauth with specified token and email address
# gs4_auth(
#   cache = '.secrets',
#   email = 'gavinmcd@gmail.com'
# )
#gs4_deauth()
gs4_auth(path = "sbck-365516-dc922ef58c73.json")

# options(
#  gargle_oauth_cache = '.secrets',
#  gargle_oauth_email = 'gavinmcd@gmail.com'
# )
# 
# gs4_auth()

# Read in raw data from Google Sheets
watershed_brigade_data_raw <- googlesheets4::read_sheet("1SVNe7XiDKMprvO3PnNbQBSRoYau1JbyqwHhx6Dz67jc",
                                                        col_types = "c",
                                                        skip = 1) 
```

```{r}
# Process data
watershed_brigade_data_processed <- watershed_brigade_data_raw %>% 
  # Don't want these rows
  filter(!(Name %in% c("Totals","Points","Name"))) %>%
  filter(!str_detect(Name,"Total")) %>%
  # Require there to be a name
  filter(!is.na(Name)) %>%
  # This gets rid of header rows that have things like "January 2021"
  mutate(Date = lubridate::mdy(Date)) %>%
  # Add month name column
  mutate(Month = lubridate::month(Date,label=TRUE,abbr = FALSE)) %>%
  # Don't want rows that don't have a date
  filter(!is.na(Date)) %>%
  # Convert weight to numeric pounds
  mutate(weight_pounds = as.numeric(`weight (lbs)`),
         group_total = as.numeric(`Group total`)) %>%
  # Add column for cleanup event ids
  mutate(cleanup_event_id = paste0(Date,"_",Location)) %>%
  # Add extra volunteers, in cases when group_total is >1
  # This will be used to count number of unique volunteers
  mutate(add_multiple_volunteers = ifelse(group_total>1,
                                          group_total-1,
                                          0))  %>%
  # Extract coordinates following this example: https://stackoverflow.com/questions/39009626/r-sets-of-coordinates-extract-from-string/39010020#39010020
  mutate(coordinates_2 = gsub('\\([^)]+\\)', '', Coordinates),
         coordinates_2 = gsub('(\\d+[.]\\d+)[.]\\d+', '\\1', Coordinates)) %>%
  separate(coordinates_2, c( 'lat','lon'), fill = 'right', sep = '[,/]', convert = TRUE) %>%
  mutate(lat = as.numeric(lat),
         lon =as.numeric(lon))

##### Let's calculate some statistics for the dashboard

# How many unique volunteers were there?
# Count up distinct number of names
# Then add extra volunteers, in cases when the group size was >1
number_unique_volunters <-
  n_distinct(watershed_brigade_data_processed$Name) +
  sum(watershed_brigade_data_processed$add_multiple_volunteers,
      na.rm=TRUE)

# How many pounds of trash were cleaned up?
number_pounds_trash <- sum(watershed_brigade_data_processed$weight_pounds,
                           na.rm=TRUE) %>%
  # Round this
  round()

# How many unique cleanup events were there?
number_volunteer_events <- n_distinct(watershed_brigade_data_processed$cleanup_event_id)
```

Row
-----------------------------------------------------------------------

### Volunteers {.value-box}

```{r}
# Icon names are from here: https://fontawesome.com/icons/users?s=solid&f=classic
valueBox(value = prettyNum(number_unique_volunters, 
                           big.mark = ","),
         icon = "fa-users")
```

### Pounds of Trash {.value-box}

```{r}
# Icon names are from here: https://fontawesome.com/icons/users?s=solid&f=classic
valueBox(value = prettyNum(number_pounds_trash, 
                           big.mark = ","),
         icon = "fa-trash")
```

### Events {.value-box}

```{r}
# Icon names are from here: https://fontawesome.com/icons/users?s=solid&f=classic
valueBox(value = prettyNum(number_volunteer_events, 
                           big.mark = ","),
         icon = "fa-calendar-check")
```

Row
-----------------------------------------------------------------------

### Watershed Brigade Cumulative Cleanup Map

```{r}
leaflet(data = watershed_brigade_data_processed) %>%
  addTiles() %>%
  # setView(lng = -119.6982,
  #         lat = 34.4208,
  #         zoom = 9) %>%
  addMarkers(lng = ~lon,
             lat = ~lat,
             clusterOptions = markerClusterOptions(),
             popup = ~paste0("<strong>Month: </strong>",as.character(Month),"<br>",
                             "<strong>Name: </strong>",as.character(Name),"<br>",
                             "<strong>Date: </strong>",as.character(Date),"<br>",
                             "<strong>Group size: </strong>",as.character(group_total),"<br>",
                             "<strong>Place: </strong>",as.character(Location),"<br>",
                             "<strong>Weight (lbs): </strong>",as.character(weight_pounds),"<br>",
                             "<strong>Bag(s): </strong>",as.character(`Amount of trash (bags)`),"<br>",
                             "<strong>Time (hours): </strong>",as.character(Hours)))
```

